datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  SUPERVISOR
  TRAINER
  PROMOTER
}

enum SaleChannel {
  RETAIL
  PROMOTER
}

model User {
  id         String      @id @default(cuid())
  telegramId String      @unique
  username   String?
  firstName  String?
  lastName   String?
  role       Role        @default(PROMOTER)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  sales      Sale[]      @relation("PromoterSales")
  bonusPayouts BonusPayout[]
  sessions   Session[]
}

model Store {
  id        String    @id @default(cuid())
  name      String
  network   String?
  region    String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  inventories InventorySnapshot[]
  sales     Sale[]
}

model Product {
  id        String    @id @default(cuid())
  sku       String    @unique
  name      String
  category  String?
  price     Decimal   @db.Decimal(12, 2)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  sales     Sale[]
  inventory InventorySnapshot[]
}

model Sale {
  id         String      @id @default(cuid())
  storeId    String
  productId  String
  promoterId String?
  quantity   Int
  amount     Decimal     @db.Decimal(12, 2)
  channel    SaleChannel @default(PROMOTER)
  soldAt     DateTime    @default(now())
  createdAt  DateTime    @default(now())

  store     Store   @relation(fields: [storeId], references: [id])
  product   Product @relation(fields: [productId], references: [id])
  promoter  User?   @relation("PromoterSales", fields: [promoterId], references: [id])
}

model InventorySnapshot {
  id         String   @id @default(cuid())
  storeId    String
  productId  String
  quantity   Int
  reportedAt DateTime @default(now())

  store   Store   @relation(fields: [storeId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

model BonusPlan {
  id          String   @id @default(cuid())
  title       String
  description String?
  bonusType   String
  value       Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  payouts     BonusPayout[]
}

model BonusPayout {
  id         String   @id @default(cuid())
  promoterId String
  planId     String?
  amount     Decimal  @db.Decimal(12, 2)
  month      String
  notes      String?
  createdAt  DateTime @default(now())

  promoter User   @relation(fields: [promoterId], references: [id])
  plan     BonusPlan? @relation(fields: [planId], references: [id])
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @unique
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}
